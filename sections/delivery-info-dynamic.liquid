{%- doc -%}
  Installation & Delivery Information Section - Dynamic Pricing
  Displays installation options, delivery options with dynamic pricing based on product weight and country.
{%- enddoc -%}

{%- liquid
  comment
    Get product context - this section should be used on product pages
  endcomment
  assign current_product = product

  if current_product == blank and section.settings.product != blank
    assign current_product = section.settings.product
  endif

  comment
    Get current variant or first available variant
  endcomment
  assign current_variant = current_product.selected_or_first_available_variant

  comment
    Calculate weight in kilograms (Shopify stores weight in grams)
  endcomment
  assign weight_grams = current_variant.weight | default: 0
  assign weight_kg = weight_grams | divided_by: 1000.0

  comment
    Get current country code
  endcomment
  assign country_code = localization.country.iso_code | default: 'ES'

  comment
    Get pricing JSON for current country from section settings
  endcomment
  assign pricing_data_raw = null

  comment
    Select the appropriate JSON based on country code
  endcomment
  assign selected_country_for_pricing = 'none'
  if section.settings.enable_dynamic_pricing
    case country_code
      when 'ES'
        assign pricing_data_raw = section.settings.pricing_spain_json
        assign selected_country_for_pricing = 'Spain (ES)'
      when 'FR'
        assign pricing_data_raw = section.settings.pricing_france_json
        assign selected_country_for_pricing = 'France (FR)'
      else
        comment
          Fallback to Spain for unsupported countries
        endcomment
        assign pricing_data_raw = section.settings.pricing_spain_json
        assign selected_country_for_pricing = 'Spain (ES) - Fallback'
    endcase
  endif

  comment
    We'll parse JSON and calculate prices in JavaScript since Liquid doesn't have parse_json
  endcomment
-%}

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  class="installation-delivery-section"
  style="{% render 'spacing-style', settings: section.settings %}"
  data-section-id="{{ section.id }}"
  data-product-id="{{ current_product.id }}"
  data-variant-id="{{ current_variant.id }}"
  data-weight-kg="{{ weight_kg }}"
  data-country-code="{{ country_code }}"
  data-pricing-json="{{ pricing_data_raw | escape }}"
  data-enable-dynamic="{{ section.settings.enable_dynamic_pricing }}"
>
  <div class="installation-delivery-grid">
    {%- comment -%} Installation Column {%- endcomment -%}
    <div class="installation-column">
      <div class="column-header">
        <span class="column-icon">
          {%- render 'icon-wrench' -%}
        </span>
        <h3 class="column-title">{{ section.settings.installation_title | default: 'Installation' }}</h3>
      </div>

      <div class="pricing-options" data-pricing-type="installation">
        {%- if section.settings.enable_dynamic_pricing -%}
          {%- comment -%} Placeholder for dynamic pricing - JavaScript will populate {%- endcomment -%}
          <div class="pricing-loading">Loading prices...</div>
        {%- else -%}
          {%- comment -%} Fallback to static prices from settings {%- endcomment -%}
          {%- if section.settings.show_installation_option_1 -%}
            <div class="pricing-row">
              <span class="pricing-label">{{ section.settings.installation_option_1_label }}</span>
              <span class="pricing-value">
                <span class="approx-text">Approx.</span> {{ section.settings.installation_option_1_price }}
              </span>
            </div>
          {%- endif -%}

          {%- if section.settings.show_installation_option_2 -%}
            <div class="pricing-row">
              <span class="pricing-label">{{ section.settings.installation_option_2_label }}</span>
              <span class="pricing-value">
                <span class="approx-text">Approx.</span> {{ section.settings.installation_option_2_price }}
              </span>
            </div>
          {%- endif -%}
        {%- endif -%}
      </div>

      <div class="installation-bottom-section">
        <div class="disclaimer-link-wrapper">
          {%- if section.settings.installation_disclaimer != blank -%}
            <p class="disclaimer-text">
              {% if section.settings.installation_disclaimer contains 'non-binding indications' %}
                {%- assign parts = section.settings.installation_disclaimer | split: 'non-binding indications' -%}
                {{ parts[0] -}}
                <strong>non-binding indications</strong>{{ parts[1] }}
              {% else %}
                {{ section.settings.installation_disclaimer }}
              {% endif %}
            </p>
          {%- endif -%}

          {%- if section.settings.installation_link_text != blank
            and section.settings.installation_link_url != blank
          -%}
            <a href="{{ section.settings.installation_link_url }}" class="info-link">
              {{ section.settings.installation_link_text }}
            </a>
          {%- endif -%}
        </div>

        {%- if section.settings.show_transport_button -%}
          <div class="transport-button-wrapper">
            <p class="button-helper-text">
              {{ section.settings.transport_button_helper | default: 'Get an installation estimate' }}
            </p>
            <button
              type="button"
              class="transport-button button button--primary"
              onclick="document.getElementById('TransportModal').showDialog()"
            >
              {{ section.settings.transport_button_text | default: 'Transport Form' }}
            </button>
          </div>
        {%- endif -%}
      </div>
    </div>

    {%- comment -%} Delivery Column {%- endcomment -%}
    <div class="delivery-column">
      <div class="column-header">
        <span class="column-icon">
          {%- render 'icon-package' -%}
        </span>
        <h3 class="column-title">{{ section.settings.delivery_title | default: 'Delivery time' }}</h3>
        {%- if section.settings.delivery_time_badge != blank -%}
          <span class="delivery-badge">{{ section.settings.delivery_time_badge }}</span>
        {%- endif -%}
      </div>

      <div class="delivery-options" data-pricing-type="delivery">
        {%- if section.settings.enable_dynamic_pricing -%}
          {%- comment -%} Placeholder for dynamic pricing - JavaScript will populate {%- endcomment -%}
          <div class="pricing-loading">Loading prices...</div>
        {%- else -%}
          {%- comment -%} Fallback to static prices from settings {%- endcomment -%}
          {%- if section.settings.show_delivery_option_1 -%}
            <div class="delivery-option">
              <div class="delivery-option-header">
                <span class="delivery-label">{{ section.settings.delivery_option_1_label }}</span>
                <span class="delivery-price">
                  <span class="approx-text">Approx.</span> {{ section.settings.delivery_option_1_price }}
                </span>
              </div>
              {%- if section.settings.delivery_option_1_description != blank -%}
                <p class="delivery-description">{{ section.settings.delivery_option_1_description }}</p>
              {%- endif -%}
            </div>
          {%- endif -%}

          {%- if section.settings.show_delivery_option_2 -%}
            <div class="delivery-option">
              <div class="delivery-option-header">
                <span class="delivery-label">{{ section.settings.delivery_option_2_label }}</span>
                <span class="delivery-price">
                  <span class="approx-text">Approx.</span> {{ section.settings.delivery_option_2_price }}
                </span>
              </div>
              {%- if section.settings.delivery_option_2_description != blank -%}
                <p class="delivery-description">{{ section.settings.delivery_option_2_description }}</p>
              {%- endif -%}
            </div>
          {%- endif -%}

          {%- if section.settings.show_delivery_option_3 -%}
            <div class="delivery-option">
              <div class="delivery-option-header">
                <span class="delivery-label">{{ section.settings.delivery_option_3_label }}</span>
                <span class="delivery-price">
                  <span class="approx-text">Approx.</span> {{ section.settings.delivery_option_3_price }}
                </span>
              </div>
              {%- if section.settings.delivery_option_3_description != blank -%}
                <p class="delivery-description">{{ section.settings.delivery_option_3_description }}</p>
              {%- endif -%}
            </div>
          {%- endif -%}
        {%- endif -%}
      </div>
    </div>
  </div>
</div>

{%- comment -%} Include the transport form modal {%- endcomment -%}
{%- if section.settings.show_transport_button -%}
  {%- render 'transport-form-modal', section: section -%}
{%- endif -%}

{%- comment -%} Load pricing renderer and variant change handler {%- endcomment -%}
{%- if section.settings.enable_dynamic_pricing -%}
  <script src="{{ 'delivery-pricing-renderer.js' | asset_url }}" defer></script>
  <script src="{{ 'delivery-info-updater.js' | asset_url }}" defer></script>
{%- endif -%}

<style>
  .installation-delivery-section {
    padding-top: {{ section.settings['padding-block-start'] | default: 40 }}px;
    padding-bottom: {{ section.settings['padding-block-end'] | default: 40 }}px;
  }
</style>

{% stylesheet %}
  .installation-delivery-grid {
    display: grid;
    grid-template-columns: 1fr;
    margin: 0 auto;
  }

  @media screen and (min-width: 768px) {
    .installation-delivery-grid {
      grid-template-columns: 1fr 1fr;
      max-width: 1390px;
    }
  }

  .installation-column {
    border: 3px solid #d9d9d9;
    padding: 15px;
  }

  .installation-column {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
  }

  .delivery-column {
    background-color: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
  }

  .installation-column,
  .delivery-column {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg, 24px);
  }

  .column-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm, 12px);
    flex-wrap: wrap;
  }

  .column-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    color: #323232;
  }

  .column-icon svg {
    width: 100%;
    height: 100%;
  }

  .column-title {
    font-size: 24px;
    font-weight: 400;
    margin: 0;
    color: #121212;
  }

  .delivery-badge {
    display: inline-block;
    color: #3cc561;
    font-size: 24px;
    font-weight: 600;
    margin-left: auto;
  }

  .pricing-options {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md, 16px);
  }

  .pricing-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--spacing-md, 16px);
    padding: var(--spacing-sm, 12px) 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
  }

  .pricing-row:last-child {
    border-bottom: none;
  }

  .pricing-label {
    flex: 1;
    font-size: 18px;
    color: #121212;
    line-height: 1.5;
    max-width: 236px;
  }

  .pricing-value {
    font-size: 14px;
    font-weight: 500;
    color: #3cc561;
    white-space: nowrap;
  }

  .pricing-value .approx-text {
    color: #121212;
  }

  .installation-bottom-section {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg, 24px);
  }

  @media screen and (min-width: 768px) {
    .installation-delivery-section {
      max-width: 1390px;
      padding-left: 25px;
      padding-right: 25px;
      margin: 0 auto;
    }
    .installation-bottom-section {
      display: grid;
      grid-template-columns: 268fr 235fr;
      gap: 50px;
    }
  }

  .disclaimer-link-wrapper {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm, 12px);
  }

  .disclaimer-text {
    font-size: 14px;
    color: #121212;
    line-height: 1.5;
    letter-spacing: 0.02em;
    margin: 0;
  }

  .disclaimer-text strong {
    font-weight: 700;
  }

  .info-link {
    font-size: 14px;
    color: #4b81bf;
    text-decoration: none;
    font-weight: 500;
    transition: opacity 0.2s ease;
  }

  .info-link:hover {
    opacity: 0.8;
    text-decoration: underline;
  }

  .transport-button-wrapper {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm, 12px);
  }

  .button-helper-text {
    font-size: 14px;
    color: #121212;
    margin: 0;
  }

  .transport-button {
    width: 100%;
    padding: 4.5px 24px;
    font-size: 14px;
    font-weight: 600;
    background-color: #4B81BF;
    color: #ffffff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .transport-button:hover {
    background-color: #3d6ba3;
  }

  .delivery-options {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg, 24px);
  }

  .delivery-option {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs, 8px);
  }

  .delivery-option-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--spacing-md, 16px);
  }

  .delivery-label {
    flex: 1;
    font-size: 18px;
    color: #121212;
    line-height: 1.5;
  }

  .delivery-price {
    font-size: 14px;
    font-weight: 500;
    color: #3cc561;
    white-space: nowrap;
  }

  .delivery-price .approx-text {
    color: #121212;
  }

  .delivery-description {
    font-size: 13px;
    color: #121212;
    line-height: 1.5;
    margin: 0;
    max-width: 279px;
  }

  @media screen and (max-width: 767px) {
    .installation-delivery-section {
      padding: var(--spacing-lg, 24px) var(--spacing-md, 16px);
    }

    .column-title {
      font-size: 16px;
    }

    .delivery-badge {
      margin-left: 0;
      width: 100%;
      text-align: center;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Delivery Info (Dynamic)",
  "tag": "section",
  "settings": [
    {
      "type": "header",
      "content": "Dynamic Pricing Settings"
    },
    {
      "type": "checkbox",
      "id": "enable_dynamic_pricing",
      "label": "Enable dynamic pricing",
      "default": true,
      "info": "When enabled, delivery and installation prices change automatically based on product weight and customer country"
    },
    {
      "type": "paragraph",
      "content": "üìã **Understanding the Price Data Below:** You'll see options like 'Curbside Delivery' with 6 numbers in brackets: [2000, 6000, 8000, 12000, 15000, 20000]. Each number = price for a weight range. **Number 1** = tiny items (0-20kg) | **Number 2** = small (21-100kg) | **Number 3** = medium (101-200kg) | **Number 4** = large (201-300kg) | **Number 5** = very large (301-500kg) | **Number 6** = huge items (500+kg). Prices are in cents: ‚Ç¨20 = 2000, ‚Ç¨50 = 5000, ‚Ç¨100 = 10000."
    },
    {
      "type": "textarea",
      "id": "pricing_spain_json",
      "label": "Spain Pricing Data (JSON)",
      "info": "üìù EXAMPLE: To change Curbside Delivery for tiny items (0-20kg) from ‚Ç¨20 to ‚Ç¨25: (1) Find the line with 'Curbside Delivery', (2) Find 'prices': [2000, 6000...], (3) Change 2000 to 2500 (first number), (4) Save. Why? 2000 cents = ‚Ç¨20, 2500 cents = ‚Ç¨25. The FIRST number is always for tiny items (0-20kg). SECOND number = small items (21-100kg), and so on. ‚ö†Ô∏è Don't remove commas between numbers or quotes around text!"
    },
    {
      "type": "textarea",
      "id": "pricing_france_json",
      "label": "France Pricing Data (JSON)",
      "info": "üìù EXAMPLE: To change Warehouse Collection for medium items (101-200kg) from ‚Ç¨10 to ‚Ç¨15: (1) Find 'Collection from SafeGear warehouse', (2) Find 'prices': [1000, 1000, 1000...], (3) Change the THIRD number from 1000 to 1500, (4) Save. Why? 1000 cents = ‚Ç¨10, 1500 = ‚Ç¨15. Position matters: 1st=tiny (0-20kg), 2nd=small (21-100kg), 3rd=medium (101-200kg), 4th=large (201-300kg), 5th=very large (301-500kg), 6th=huge (500+kg). France prices are usually Spain prices + ‚Ç¨10. ‚ö†Ô∏è Keep commas and quotes!"
    },
    {
      "type": "product",
      "id": "product",
      "label": "Product (optional)",
      "info": "Leave blank to use current product context"
    },
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color scheme",
      "options": [
        {
          "value": "scheme-1",
          "label": "Scheme 1"
        },
        {
          "value": "scheme-2",
          "label": "Scheme 2"
        },
        {
          "value": "scheme-3",
          "label": "Scheme 3"
        },
        {
          "value": "scheme-4",
          "label": "Scheme 4"
        },
        {
          "value": "scheme-5",
          "label": "Scheme 5"
        }
      ],
      "default": "scheme-1"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Top padding",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Bottom padding",
      "default": 40
    },
    {
      "type": "header",
      "content": "Installation Settings"
    },
    {
      "type": "text",
      "id": "installation_title",
      "label": "Installation title",
      "default": "Installation"
    },
    {
      "type": "textarea",
      "id": "installation_disclaimer",
      "label": "Installation disclaimer",
      "default": "These prices are non-binding indications. The cost depends on location, access, stairs, weight etc."
    },
    {
      "type": "text",
      "id": "installation_link_text",
      "label": "Installation link text",
      "default": "More about delivery and Installation"
    },
    {
      "type": "url",
      "id": "installation_link_url",
      "label": "Installation link URL"
    },
    {
      "type": "header",
      "content": "Transport Form Button"
    },
    {
      "type": "checkbox",
      "id": "show_transport_button",
      "label": "Show transport form button",
      "default": true
    },
    {
      "type": "text",
      "id": "transport_button_helper",
      "label": "Button helper text",
      "default": "Get an installation estimate"
    },
    {
      "type": "text",
      "id": "transport_button_text",
      "label": "Button text",
      "default": "Transport Form"
    },
    {
      "type": "text",
      "id": "modal_title",
      "label": "Modal title",
      "default": "Transport & Installation Estimate"
    },
    {
      "type": "textarea",
      "id": "modal_subtitle",
      "label": "Modal subtitle",
      "default": "Fill out this form to get a personalized quote for transport and installation."
    },
    {
      "type": "header",
      "content": "Delivery Settings"
    },
    {
      "type": "text",
      "id": "delivery_title",
      "label": "Delivery title",
      "default": "Delivery time"
    },
    {
      "type": "text",
      "id": "delivery_time_badge",
      "label": "Delivery time badge text",
      "default": "1-2 weeks"
    },
    {
      "type": "header",
      "content": "Fallback Static Pricing"
    },
    {
      "type": "checkbox",
      "id": "show_installation_option_1",
      "label": "Show installation option 1",
      "default": false
    },
    {
      "type": "text",
      "id": "installation_option_1_label",
      "label": "Installation option 1 label",
      "default": "Delivered to final location"
    },
    {
      "type": "text",
      "id": "installation_option_1_price",
      "label": "Installation option 1 price",
      "default": "DKK 4 000"
    },
    {
      "type": "checkbox",
      "id": "show_installation_option_2",
      "label": "Show installation option 2",
      "default": false
    },
    {
      "type": "text",
      "id": "installation_option_2_label",
      "label": "Installation option 2 label",
      "default": "Delivered to final location with bolting to floor/wall"
    },
    {
      "type": "text",
      "id": "installation_option_2_price",
      "label": "Installation option 2 price",
      "default": "DKK 5 000"
    },
    {
      "type": "checkbox",
      "id": "show_delivery_option_1",
      "label": "Show delivery option 1",
      "default": false
    },
    {
      "type": "text",
      "id": "delivery_option_1_label",
      "label": "Delivery option 1 label",
      "default": "Curbside Delivery"
    },
    {
      "type": "text",
      "id": "delivery_option_1_price",
      "label": "Delivery option 1 price",
      "default": "DKK 400"
    },
    {
      "type": "textarea",
      "id": "delivery_option_1_description",
      "label": "Delivery option 1 description",
      "default": "Delivery to the edge of your property, where the item will be left for you to bring inside."
    },
    {
      "type": "checkbox",
      "id": "show_delivery_option_2",
      "label": "Show delivery option 2",
      "default": false
    },
    {
      "type": "text",
      "id": "delivery_option_2_label",
      "label": "Delivery option 2 label",
      "default": "Collection from SafeGear warehouse"
    },
    {
      "type": "text",
      "id": "delivery_option_2_price",
      "label": "Delivery option 2 price",
      "default": "DKK 0"
    },
    {
      "type": "textarea",
      "id": "delivery_option_2_description",
      "label": "Delivery option 2 description"
    },
    {
      "type": "checkbox",
      "id": "show_delivery_option_3",
      "label": "Show delivery option 3",
      "default": false
    },
    {
      "type": "text",
      "id": "delivery_option_3_label",
      "label": "Delivery option 3 label"
    },
    {
      "type": "text",
      "id": "delivery_option_3_price",
      "label": "Delivery option 3 price"
    },
    {
      "type": "textarea",
      "id": "delivery_option_3_description",
      "label": "Delivery option 3 description"
    }
  ],
  "presets": [
    {
      "name": "Delivery Info (Dynamic)"
    }
  ]
}
{% endschema %}
